# 第二章 系统架构简介

> IA-32架构（从Intel386系列处理器开始）为操作系统和系统开发软件提供了额外的支持，支持好几种操作模式，包括：
>
> - 实模式，保护模式，虚拟8086模式，系统管理模式。这些有时候被称为遗留模式
>
> Intel 64架构支持几乎所有IA-32架构有的系统编程组件并且把他们扩展到一种新的操作模式IA-32e模式，这种操作模式支持64位编程环境。IA-32e模式允许软件处于下面两种子模式中的任一一种:
>
> - 64位模式，它支持64位操作系统模式和 64位应用程序模式
> - 兼容模式，它支持大多数遗留模式，它和64位应用程序模式共存在64位系统模式下
>
> IA-32系统级架构包括下列功能:
>
> - 内存管理
> - 软件模块保护
> - 多任务支持
> - 异常和终端处理
> - 多处理支持
> - 缓存管理
> - 硬件资源和电源管理
> - 调试支持和性能监控
>
> 这一章的内容包括IA-32架构的每一个功能模块，用于初始化和控制处理器的系统寄存器以及处理器系统级别的指令介绍
>
> 许多系统级别的特性只被系统程序使用，但应用程序开发者想要为应用程序创造一个可靠安全的环境也需要阅读这一章。
>
> 简介和后面大部分的章节专注于IA-32架构的保护模式操作和Intel 64架构的IA-32e模式
>
> 所有的Intel 64和IA-32架构处理器在开机和重启以后立马进入实模式（见第9章 “处理器管理和初始化”），然后通过程序实现从实模式到保护模式或者从实模式到IA-32e模式。
>
>   
##2.1 系统级架构简介
>系统级架构包含一系列寄存器，数据结构，指令。有了这些以后，系统架构就可以完成一系列功能：内存管理，中断和异常处理，任务调度，多处理器控制。
>图片2-1 提供了所有的32位模式下系统寄存器，数据结构。
>图片2-2 提供了所有的IA-32e模式下系统寄存器，数据结构。
>
>![2-1](https://raw.githubusercontent.com/coolboy4me/intel-/master/pic/2/2-1.png)
>
> ![2-2](https://raw.githubusercontent.com/coolboy4me/intel-/master/pic/2/2-2.png)
>
> ###2.1.1 全局描述符表和局部描述符表
> 保护模式下，所有的内存访问都是通过全局描述符表(GDT)或者局部描述符表(LDT)，见图2-1。这些表包括了全部的描述符。段描述符提供了段的基质，访问权限，类型和使用信息。
> 每一个段描述符有相对应的段选择子。段选择子提供了GDT或者LDT中的索引（段描述符的偏移），表示是在GDT还是在LDT中的标志，还有访问权限。
> 需要提供段选择子和偏移才能够在段中访问一个字节。通过段选择子可以在GDT或者LDT中访问段描述符，通过段描述符可以得到段在线性地址空间里面的基质。偏移就是一个字节的地址和字节所在段的地址的差值。在处理器满足条件（当前权限等级(CPL)下可以访问）的情况下，代码段，数据段，堆栈段都可以通过这个机制来访问。当前权限等级（CPL）是正在执行的代码段的保护级别。
> 见图2-1. 实线箭头表示线性地址；虚线箭头表示段选择子；点箭头表示物理地址。简单来说，段选择子都指向段描述符，然而实际上从段段选择子都要通过GDT或者LDT转换下才能得到段描述符。
> GDT在线性地址中的基质存放在GDTR中，而LDT的存放在LDTR中。
> ####2.1.1.1 IA-32e模式下的全局描述符表和局部描述表
> GDTR和LDTR在IA-32e的子模式（64位模式和兼容模式）中都扩展成64位。详见3.5.2 “IA-32e模式中的段描述符表”
> 64位模式下全局描述符表和局部描述符表都被扩展用来支持64位基质，（16位LDT描述符包含64位基质和各种属性）。兼容模式下描述符不扩展。
>
##2.1.2 系统段，系统描述符和门

> 除了代码段，数据段，堆栈段，还有两种系统段用来支撑程序运行环境：任务状态段（TSS）和LDT。因为GDT不能通过段选择子和段描述符来访问，所以GDT不被认为是一个段，而TSS和LDT都有对应段描述符。
> 架构也定义了一系列特殊的描述符，门（调用门，中断门，陷阱门和任务门）。